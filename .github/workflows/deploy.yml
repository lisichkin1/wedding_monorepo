name: Deploy Services

on:
  push:
    branches: [main, master]
    paths-ignore:
      - "**/*.md"
      - "**/*.txt"
      - ".gitignore"
      - "README.md"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Detect changed services
        id: detect
        run: |
          echo "Checking changed files..."
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files: $CHANGED_FILES"

          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
          FRONTEND_CHANGED="false"
          BACKEND_CHANGED="false"
          BOT_CHANGED="false"
          COMPOSE_CHANGED="false"

          if echo "$CHANGED_FILES" | grep -q "services/frontend"; then
            FRONTEND_CHANGED="true"
          fi

          if echo "$CHANGED_FILES" | grep -q "services/backend"; then
            BACKEND_CHANGED="true"
          fi

          if echo "$CHANGED_FILES" | grep -q "services/bot"; then
            BOT_CHANGED="true"
          fi

          if echo "$CHANGED_FILES" | grep -q "docker-compose"; then
            COMPOSE_CHANGED="true"
          fi

          # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã –≤ –∫–æ—Ä–Ω–µ (–∫—Ä–æ–º–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã—Ö), —Ç–æ–∂–µ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
          if echo "$CHANGED_FILES" | grep -v "^services/" | grep -v "^\.github/" | grep -v "^README" | grep -v "\.md$" | grep -q "."; then
            COMPOSE_CHANGED="true"
          fi

          echo "frontend_changed=$FRONTEND_CHANGED" >> $GITHUB_OUTPUT
          echo "backend_changed=$BACKEND_CHANGED" >> $GITHUB_OUTPUT
          echo "bot_changed=$BOT_CHANGED" >> $GITHUB_OUTPUT
          echo "compose_changed=$COMPOSE_CHANGED" >> $GITHUB_OUTPUT

      - name: Copy files to server
        run: |
          echo "üì¶ Copying files to server..."
          rsync -avz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='*.log' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ root@${{ secrets.SERVER_IP }}:/root/projects/wedding_monorepo/

      - name: Deploy to server
        run: |
          echo "üöÄ Starting deployment..."

          ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} << 'EOF'
            cd /root/projects/wedding_monorepo
            
            # –°–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è –¥–µ–ø–ª–æ—è
            SERVICES_TO_DEPLOY=""
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
            if [ "${{ steps.detect.outputs.frontend_changed }}" = "true" ]; then
              SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY frontend"
              echo "üîß Will deploy frontend"
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—ç–∫–µ–Ω–¥ (–µ—Å–ª–∏ –±—É–¥–µ—Ç)
            if [ "${{ steps.detect.outputs.backend_changed }}" = "true" ]; then
              SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY backend"
              echo "üîß Will deploy backend"
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–æ—Ç–∞ (–µ—Å–ª–∏ –±—É–¥–µ—Ç)
            if [ "${{ steps.detect.outputs.bot_changed }}" = "true" ]; then
              SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY telegram-bot"
              echo "üîß Will deploy telegram-bot"
            fi
            
            # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è docker-compose –∏–ª–∏ –¥—Ä—É–≥–∏–µ –∫–æ—Ä–Ω–µ–≤—ã–µ —Ñ–∞–π–ª—ã
            if [ "${{ steps.detect.outputs.compose_changed }}" = "true" ]; then
              echo "üîÑ Docker-compose changed, redeploying all services"
              docker compose down 2>/dev/null || true
              docker compose up -d --build
            elif [ ! -z "$SERVICES_TO_DEPLOY" ]; then
              echo "üîÑ Deploying services: $SERVICES_TO_DEPLOY"
              for service in $SERVICES_TO_DEPLOY; do
                echo "üì¶ Building $service..."
                docker compose up -d --build $service
              done
            else
              echo "‚úÖ No services to deploy"
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "üìä Current status:"
            docker compose ps
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
            if docker compose ps | grep -q "frontend.*Up"; then
              echo "üåê Frontend is running at: http://${{ secrets.SERVER_IP }}:3000"
            fi
          EOF
