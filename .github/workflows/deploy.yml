name: Deploy Services

on:
  push:
    branches: [main, master]
    paths-ignore:
      - "**/*.md"
      - "**/*.txt"
      - ".gitignore"
      - "README.md"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # –í–∞–∂–Ω–æ: –ø–æ–ª—É—á–∞–µ–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Detect changed services
        id: detect
        run: |
          echo "Checking changed files..."

          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            # –ü–µ—Ä–≤—ã–π –∫–æ–º–º–∏—Ç - –±–µ—Ä–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã
            CHANGED_FILES=$(git ls-tree -r --name-only HEAD)
          else
            # –û–±—ã—á–Ω—ã–π –∫–æ–º–º–∏—Ç - —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
          FRONTEND_CHANGED="false"
          BACKEND_CHANGED="false"
          BOT_CHANGED="false"
          COMPOSE_CHANGED="false"

          if echo "$CHANGED_FILES" | grep -q "services/frontend"; then
            FRONTEND_CHANGED="true"
            echo "Frontend changed"
          fi

          if echo "$CHANGED_FILES" | grep -q "services/backend"; then
            BACKEND_CHANGED="true"
            echo "Backend changed"
          fi

          if echo "$CHANGED_FILES" | grep -q "services/bot"; then
            BOT_CHANGED="true"
            echo "Bot changed"
          fi

          if echo "$CHANGED_FILES" | grep -q "docker-compose"; then
            COMPOSE_CHANGED="true"
            echo "Docker-compose changed"
          fi

          # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã –≤ –∫–æ—Ä–Ω–µ (–∫—Ä–æ–º–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã—Ö), —Ç–æ–∂–µ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
          if echo "$CHANGED_FILES" | grep -v "^services/" | grep -v "^\.github/" | grep -v "^README" | grep -v "\.md$" | grep -q "."; then
            COMPOSE_CHANGED="true"
            echo "Other root files changed"
          fi

          echo "frontend_changed=$FRONTEND_CHANGED" >> $GITHUB_OUTPUT
          echo "backend_changed=$BACKEND_CHANGED" >> $GITHUB_OUTPUT
          echo "bot_changed=$BOT_CHANGED" >> $GITHUB_OUTPUT
          echo "compose_changed=$COMPOSE_CHANGED" >> $GITHUB_OUTPUT

      - name: Copy files to server
        run: |
          echo "üì¶ Copying files to server..."
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='*.log' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ root@${{ secrets.SERVER_IP }}:/root/projects/wedding_monorepo/

      - name: Create backend .env file securely
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} "bash -s" << EOF
          mkdir -p /root/projects/wedding_monorepo/services/backend
          cat > /root/projects/wedding_monorepo/services/backend/.env << BACKEND_ENV
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          FRONTEND_URL=${{ secrets.FRONTEND_URL }}
          BACKEND_URL=${{ secrets.BACKEND_URL }}
          BOT_API_KEY=${{ secrets.BOT_API_KEY }}
          NODE_ENV=production
          BACKEND_ENV
          EOF

      - name: Create frontend .env file securely
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} "bash -s" << EOF
          mkdir -p /root/projects/wedding_monorepo/services/frontend
          cat > /root/projects/wedding_monorepo/services/frontend/.env << FRONTEND_ENV
          VITE_HOST=${{ secrets.BACKEND_URL }}
          NODE_ENV=production
          FRONTEND_ENV
          EOF

      - name: Create telegram .env file securely
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} "bash -s" << EOF
          mkdir -p /root/projects/wedding_monorepo/services/telegram-bot
          cat > /root/projects/wedding_monorepo/services/telegram-bot/.env << TG_ENV
          BOT_TOKEN=${{ secrets.BOT_TOKEN }}
          BACKEND_URL=${{ secrets.BACKEND_URL }}
          BOT_API_KEY=${{ secrets.BOT_API_KEY }}
          ALLOWED_USER_IDS=${{ secrets.ALLOWED_USER_IDS }}
          BOT_OWNER_ID=${{ secrets.BOT_OWNER_ID }}
          TG_ENV
          EOF

      - name: Create postgres.env file securely
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} "bash -s" << 'EOF'
          # –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
          mkdir -p /root/projects/wedding_monorepo

          # –°–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏
          cat > /root/projects/wedding_monorepo/postgres.env << 'POSTGRES_ENV'
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_ENV

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä–æ–≥–∏–µ –ø—Ä–∞–≤–∞: —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å/–ø–∏—Å–∞—Ç—å
          chmod 600 /root/projects/wedding_monorepo/postgres.env

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω
          echo "postgres.env created with permissions: $(stat -c '%a' /root/projects/wedding_monorepo/postgres.env)"
          EOF

      - name: Deploy to server
        run: |
          echo "üöÄ Starting deployment..."

          ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} << 'EOF'
            cd /root/projects/wedding_monorepo
            
            # –°–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è –¥–µ–ø–ª–æ—è
            SERVICES_TO_DEPLOY=""
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
            if [ "${{ steps.detect.outputs.frontend_changed }}" = "true" ]; then
              SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY frontend"
              echo "üîß Will deploy frontend"
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—ç–∫–µ–Ω–¥ (–µ—Å–ª–∏ –±—É–¥–µ—Ç)
            if [ "${{ steps.detect.outputs.backend_changed }}" = "true" ]; then
              SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY backend"
              echo "üîß Will deploy backend"
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–æ—Ç–∞ (–µ—Å–ª–∏ –±—É–¥–µ—Ç)
            if [ "${{ steps.detect.outputs.bot_changed }}" = "true" ]; then
              SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY telegram-bot"
              echo "üîß Will deploy telegram-bot"
            fi
            
            # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è docker-compose –∏–ª–∏ –¥—Ä—É–≥–∏–µ –∫–æ—Ä–Ω–µ–≤—ã–µ —Ñ–∞–π–ª—ã
            if [ "${{ steps.detect.outputs.compose_changed }}" = "true" ]; then
              echo "üîÑ Docker-compose changed, redeploying all services"
              docker compose down 2>/dev/null || true
              docker compose up -d --build
            elif [ ! -z "$SERVICES_TO_DEPLOY" ]; then
              echo "üîÑ Deploying services: $SERVICES_TO_DEPLOY"
              for service in $SERVICES_TO_DEPLOY; do
                echo "üì¶ Building $service..."
                docker compose up -d --build $service
              done
            else
              echo "‚úÖ No services to deploy"
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "üìä Current status:"
            docker compose ps
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
            if docker compose ps | grep -q "frontend.*Up"; then
              echo "üåê Frontend is running at: http://${{ secrets.SERVER_IP }}:3000"
            fi
          EOF
