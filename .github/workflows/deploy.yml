name: Deploy Monorepo Services

on:
  push:
    branches: [main, master]
    paths-ignore:
      - "**/*.md"
      - "**/*.txt"
      - ".gitignore"
      - ".editorconfig"
      - "**/*.spec.js"
      - "**/*.test.js"

jobs:
  # 1. –î–ï–¢–ï–ö–¢–û–† –ò–ó–ú–ï–ù–ï–ù–ò–ô
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend-changed: ${{ steps.filter.outputs.frontend }}
      backend-changed: ${{ steps.filter.outputs.backend }}
      bot-changed: ${{ steps.filter.outputs.bot }}
      docker-compose-changed: ${{ steps.filter.outputs.docker-compose }}
      all-changed: ${{ steps.filter.outputs.any_changed }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed services
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            frontend:
              - 'services/frontend/**'
              - 'package-lock.json'
              - 'package.json'
            backend:
              - 'services/backend/**'
            bot:
              - 'services/bot/**'
            docker-compose:
              - 'docker-compose.yml'
              - 'docker-compose.*.yml'
              - '.github/workflows/deploy.yml'
            any_changed: '*'  # –õ—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

  # 2. –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–´–ï –ü–†–û–í–ï–†–ö–ò (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  lint-and-test:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.frontend-changed == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: services/frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd services/frontend
          npm ci

      - name: Lint frontend
        run: |
          cd services/frontend
          npm run lint || true

      - name: Build frontend
        run: |
          cd services/frontend
          npm run build

  # 3. –û–°–ù–û–í–ù–û–ô –î–ï–ü–õ–û–ô
  deploy:
    needs: [detect-changes, lint-and-test]
    runs-on: ubuntu-latest
    if: ${{ needs.detect-changes.outputs.all-changed == 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH for deployment
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Sync changed files
        run: |
          echo "üîÑ Syncing files to server..."

          # –ö–æ–ø–∏—Ä—É–µ–º –í–°–ï —Ñ–∞–π–ª—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å)
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.env' \
            --exclude='*.log' \
            -e "ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30" \
            ./ root@${{ secrets.SERVER_IP }}:/root/projects/wedding_monorepo/

      - name: Execute deployment script
        run: |
          echo "üöÄ Starting deployment..."

          # –ü–µ—Ä–µ–¥–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö
          FRONTEND_CHANGED="${{ needs.detect-changes.outputs.frontend-changed }}"
          BACKEND_CHANGED="${{ needs.detect-changes.outputs.backend-changed }}"
          BOT_CHANGED="${{ needs.detect-changes.outputs.bot-changed }}"
          DOCKER_COMPOSE_CHANGED="${{ needs.detect-changes.outputs.docker-compose-changed }}"

          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 root@${{ secrets.SERVER_IP }} << EOF
            set -e
            
            echo "üìÅ Changing to project directory..."
            cd /root/projects/wedding_monorepo
            
            # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ–ø–ª–æ—è —Å–µ—Ä–≤–∏—Å–∞
            deploy_service() {
              local service_name=\$1
              echo "üîß Deploying \${service_name}..."
              
              # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å
              docker compose stop \${service_name} 2>/dev/null || true
              docker compose rm -f \${service_name} 2>/dev/null || true
              
              # –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
              docker compose up -d --build \${service_name}
              
              # –ñ–¥–µ–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º
              sleep 5
              echo "üìä Status of \${service_name}:"
              docker compose ps \${service_name}
              
              # –õ–æ–≥–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å—Ç—Ä–æ–∫
              echo "üìã Logs tail for \${service_name}:"
              docker compose logs --tail=5 \${service_name} 2>/dev/null || true
            }
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã –¥–µ–ø–ª–æ–∏—Ç—å
            SERVICES_TO_DEPLOY=""
            
            if [ "$FRONTEND_CHANGED" = "true" ] || [ "$DOCKER_COMPOSE_CHANGED" = "true" ]; then
              SERVICES_TO_DEPLOY="\${SERVICES_TO_DEPLOY} frontend"
            fi
            
            if [ "$BACKEND_CHANGED" = "true" ] || [ "$DOCKER_COMPOSE_CHANGED" = "true" ]; then
              SERVICES_TO_DEPLOY="\${SERVICES_TO_DEPLOY} backend"
            fi
            
            if [ "$BOT_CHANGED" = "true" ] || [ "$DOCKER_COMPOSE_CHANGED" = "true" ]; then
              SERVICES_TO_DEPLOY="\${SERVICES_TO_DEPLOY} telegram-bot"
            fi
            
            # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è docker-compose –∏–ª–∏ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –≤—Å—ë
            if [ "$DOCKER_COMPOSE_CHANGED" = "true" ] && [ -z "\$SERVICES_TO_DEPLOY" ]; then
              echo "üîÑ Docker-compose changed, redeploying all services..."
              docker compose down
              docker compose up -d --build
            else
              # –î–µ–ø–ª–æ–∏–º –∫–∞–∂–¥—ã–π –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å
              for service in \$SERVICES_TO_DEPLOY; do
                deploy_service "\$service"
              done
            fi
            
            # –§–∏–Ω–∞–ª: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
            echo "üéØ Final status of all services:"
            docker compose ps
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
            if docker compose ps frontend | grep -q "Up"; then
              echo "üåê Frontend is running at: http://${{ secrets.SERVER_IP }}:3000"
            fi
            
          EOF

      - name: Send deployment notification
        if: success()
        run: |
          echo "‚úÖ Deployment completed successfully!"
          # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram/Slack
          # curl -X POST ...

  # 4. –†–û–õ–ë–≠–ö –ü–†–ò –ù–ï–£–î–ê–ß–ï
  rollback:
    needs: deploy
    if: failure() && needs.deploy.result == 'failure'
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH for rollback
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Execute rollback
        run: |
          echo "üîÑ Attempting rollback..."

          ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} << 'EOF'
            cd /root/projects/wedding_monorepo
            
            echo "‚èÆÔ∏è Rolling back to previous version..."
            
            # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º git (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
            git checkout HEAD~1 2>/dev/null || true
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–µ–π
            docker compose down
            docker compose up -d
            
            echo "‚úÖ Rollback completed"
            echo "üìä Current status:"
            docker compose ps
          EOFs
